<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Nevis</title>
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <header>
        <img src="./Nevis Logo.png" id="logo" />
        <p>Nevis</p>
        <a id="close" href="javascript:window.close()">
            <svg color="white" width="10" height="10">
                <path d="M 0,0 0,0.7 4.3,5 0,9.3 0,10 0.7,10 5,5.7 9.3,10 10,10 10,9.3 5.7,5 10,0.7 10,0 9.3,0 5,4.3 0.7,0 Z"></path>
            </svg>
        </a>
        <a id="maximize">
            <svg color="white" id="icon-min" width="10" height="10">
                <path d="M 0,0 0,10 10,10 10,0 Z M 1,1 9,1 9,9 1,9 Z"></path>
            </svg>
            <svg color="white" id="icon-max" width="10" height="10">
                <path d="m 2,1e-5 0,2 -2,0 0,8 8,0 0,-2 2,0 0,-8 z m 1,1 6,0 0,6 -1,0 0,-5 -5,0 z m -2,2 6,0 0,6 -6,0 z"></path>
            </svg>
        </a>
        <a id="minimize">
            <svg color="white" width="10" height="10">
                <path d="M 0,5 10,5 10,6 0,6 Z"></path>
            </svg>
        </a>

    </header>


    <main>
        <div id="menu-panel">
            <div id="download-menu" style="display:none">
                <p class="label">Port:</p>
                <div id='port'>
                    <p id="port-content" class="content"></p>
                    <svg fill="#000000" viewBox="0 0 24 24" width="20">
                        <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                        <path d="M0-.75h24v24H0z" fill="none" />
                    </svg>

                </div>
                <div id="port-menu" class="hidden">

                </div>
                <p class="label">Baud Rate:</p>
                <div id="baud">
                    <p id="baud-content" class="content">4800</p>
                    <svg fill="#000000" viewBox="0 0 24 24" width="20">
                        <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                        <path d="M0-.75h24v24H0z" fill="none" />
                    </svg>

                </div>
                <div id="baud-menu" class="hidden">
                    <p id="baud-serial">4800 (Serial)</p>
                    <p id="baud-usb">38400 (USB)</p>
                </div>

                <button id="connect">Connect</button>
            </div>
            <div id="main-menu" style="display:none">
                <p id="menu-download">Download</p>
                <p id="menu-entries">Entries</p>
            </div>
            <button id="back">Back</button>
        </div>
        <div id="scroll" height='400px'>

            <div id="download-output" style="display:none">

            </div>
            <div id="entries" style="display:none">
                <form>
                    <div class="text-input">
                        <input id="name" type="text" required/>
                        <label for="name">Name</label>
                    </div>
                    <div class="text-input">
                        <input id="age-class" type="text" required/>
                        <label for="age-class">Age Class</label>
                    </div>
                    <div class="text-input">
                        <input id="course" type="text" required/>
                        <label for="course">Course</label>
                    </div>
                </form>

            </div>
        </div>
    </main>

    <script>
        const ipc = require('electron').ipcRenderer

        var SerialPort = require('serialport');

        document.getElementById('download-output').setAttribute('style', 'display:none;')
        document.getElementById('entries').setAttribute('style', 'display:none;')
        document.getElementById('download-menu').setAttribute('style', 'display:none;')
        document.getElementById('main-menu').setAttribute('style', 'display:block;')
        document.getElementById('back').setAttribute('style', 'display:none;')

        document.getElementById('menu-download').addEventListener('click', function () {
            document.getElementById('download-output').setAttribute('style', 'display:block;')
            document.getElementById('entries').setAttribute('style', 'display:none;')
            document.getElementById('download-menu').setAttribute('style', 'display:block;')
            document.getElementById('main-menu').setAttribute('style', 'display:none;')
            document.getElementById('back').setAttribute('style', 'display:block;')
        })

        document.getElementById('menu-entries').addEventListener('click', function () {
            document.getElementById('download-output').setAttribute('style', 'display:none;')
            document.getElementById('entries').setAttribute('style', 'display:block;')
            document.getElementById('download-menu').setAttribute('style', 'display:none;')
            document.getElementById('main-menu').setAttribute('style', 'display:none;')
            document.getElementById('back').setAttribute('style', 'display:block;')
        })

        document.getElementById('back').addEventListener('click', function () {
            if (document.getElementById('download-output').getAttribute('style') == 'display:block;') {
                if (document.getElementById('connect').innerText == 'Disconnect') {
                    port.close();
                }
            }

            document.getElementById('download-output').setAttribute('style', 'display:none;')
            document.getElementById('entries').setAttribute('style', 'display:none;')
            document.getElementById('download-menu').setAttribute('style', 'display:none;')
            document.getElementById('main-menu').setAttribute('style', 'display:block;')
            document.getElementById('back').setAttribute('style', 'display:none;')

        })

        /* ----- Window Commands & Icons ----- */

        document.getElementById('icon-min').setAttribute('style', 'display:inline');
        document.getElementById('icon-max').setAttribute('style', 'display:none');

        document.getElementById('maximize').addEventListener('click', function () {
            ipc.send('window', 'maximize')
        })

        document.getElementById('minimize').addEventListener('click', function () {
            ipc.send('window', 'minimize')
        })

        ipc.on('window', function (event, arg) {
            if (arg == 'minimized') {
                document.getElementById('icon-min').setAttribute('style', 'display:inline')
                document.getElementById('icon-max').setAttribute('style', 'display:none')
            }
            else if (arg == 'maximized') {
                document.getElementById('icon-min').setAttribute('style', 'display:none')
                document.getElementById('icon-max').setAttribute('style', 'display:inline')
            }
        })

        ipc.on('resize', function (event, arg) {
            var pixels = arg[1] - 30
            document.getElementById('scroll').setAttribute('style', "height:" + pixels + "px")

        })


        // Menu Collapse
        const portMenu = document.getElementById('port-menu');
        const baudMenu = document.getElementById('baud-menu');


        document.getElementById('baud').addEventListener('click', function () {
            if (baudMenu.getAttribute('class') == 'hidden') {
                baudMenu.setAttribute('class', ' ')
            }
            else {
                baudMenu.setAttribute('class', 'hidden')
            }
        })
        document.getElementById('baud-usb').addEventListener('click', function () {
            document.getElementById('baud-content').innerText = "38400";
            port.baudrate = 38400
            baudMenu.setAttribute('class', 'hidden')
        })
        document.getElementById('baud-serial').addEventListener('click', function () {
            document.getElementById('baud-content').innerText = "4800";
            port.baudrate = 4800
            baudMenu.setAttribute('class', 'hidden')
        })


        document.getElementById('port').addEventListener('click', function () {

            if (portMenu.getAttribute('class') == 'hidden') {

                portMenu.innerHTML = "";
                portsList = ""
                noOfPorts = 1
                SerialPort.list(function (err, ports) {
                    ports.forEach(function (port) {

                        portMenu.innerHTML = portMenu.innerHTML + "<p id='" + noOfPorts + "' class='portslistitem'> " + port.comName + "</p>";
                        document.getElementById(noOfPorts).addEventListener('click', function () {
                            document.getElementById('port-content').innerText = document.getElementById(noOfPorts).innerText;
                            portMenu.setAttribute('class', 'hidden')
                            portName = document.getElementById('port-content').innerText;
                            noOfPorts++;
                        })
                    });
                    if (ports.length < 1) {

                        portMenu.innerHTML = portMenu.innerHTML + "<p id='NoDev'>No Devices Detected</p>";

                        document.getElementById('NoDev').addEventListener('click', function () {
                            document.getElementById('port-content').innerText = " ";
                            portMenu.setAttribute('class', 'hidden')
                        })
                    }

                });

                portMenu.setAttribute('class', '')

            }
            else {

                portMenu.setAttribute('class', 'hidden')

            }
        })

        //Read Port
        require('./si-data.js')

    </script>
</body>

</html>