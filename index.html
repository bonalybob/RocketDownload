<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Nevis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styles.css" />
</head>

<body>
    <header>
        <img src="Nevis Logo.png" id="logo" />
        <p>Nevis</p>
        <a id="close" href="javascript:window.close()">
            <svg color="white" width="10" height="10">
                <path d="M 0,0 0,0.7 4.3,5 0,9.3 0,10 0.7,10 5,5.7 9.3,10 10,10 10,9.3 5.7,5 10,0.7 10,0 9.3,0 5,4.3 0.7,0 Z"></path>
            </svg>
        </a>
        <a id="maximize">
            <svg color="white" id="icon-min" width="10" height="10" style="display:none">
                <path d="M 0,0 0,10 10,10 10,0 Z M 1,1 9,1 9,9 1,9 Z"></path>
            </svg>
            <svg color="white" id="icon-max" width="10" height="10">
                <path d="m 2,1e-5 0,2 -2,0 0,8 8,0 0,-2 2,0 0,-8 z m 1,1 6,0 0,6 -1,0 0,-5 -5,0 z m -2,2 6,0 0,6 -6,0 z"></path>
            </svg>
        </a>
        <a id="minimize">
            <svg color="white" width="10" height="10">
                <path d="M 0,5 10,5 10,6 0,6 Z"></path>
            </svg>
        </a>
    </header>


    <main>
        <div id="menu-panel">
            <div id="main-menu" style="display:none;">
                <p id="menu-download">Download</p>
                <p id="menu-entries">Entries</p>
                <p id="menu-results">Results</p>
                <p id="menu-courses">Courses</p>
                <p id="menu-about">About</p>
            </div>

            <div id="scroll-menu">
                <div id="database-menu">
                    <button id="database-new">New Database</button>
                    <button id="database-select">Select Database</button>
                    <button id="database-open">Open Database</button>
                </div>
                <div id="download-menu" style="display:none;">
                    <p class="label">Port:</p>
                    <div id='port'>
                        <p id="port-content" class="content"></p>
                        <svg fill="#000000" viewBox="0 0 24 24" width="20">
                            <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                            <path d="M0-.75h24v24H0z" fill="none" />
                        </svg>

                    </div>
                    <div id="port-menu" class="hidden">

                    </div>
                    <p class="label">Baud Rate:</p>
                    <div id="baud">
                        <p id="baud-content" class="content">4800</p>
                        <svg fill="#000000" viewBox="0 0 24 24" width="20">
                            <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                            <path d="M0-.75h24v24H0z" fill="none" />
                        </svg>

                    </div>
                    <div id="baud-menu" class="hidden">
                        <p id="baud-serial">4800 (Serial)</p>
                        <p id="baud-usb">38400 (USB)</p>
                    </div>
                    <p class="label">Printer:</p>
                    <div id="printer">
                        <p id="printer-content" class="content">No Printing</p>
                        <svg fill="#000000" viewBox="0 0 24 24" width="20">
                            <path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6z" />
                            <path d="M0-.75h24v24H0z" fill="none" />
                        </svg>

                    </div>
                    <div id="printer-menu" class="hidden">


                    </div>
                    <button id="connect">Connect</button>

                </div>
                <div id="entries-menu" style="display:none;">
                    <button id="search-entries">Search Entries</button>
                    <button id="add-entry">Add Entry</button>
                </div>
                <div id="entries-add-menu" style="display:none;">
                    <button id="entries-submit">Save Entry</button>
                    <button id="entry-clear">Blank Entry</button>
                </div>
                <div id="entries-update-menu" style="display:none;">
                    <button id="entries-update">Update Entry</button>
                    <button id="entries-delete">Delete Entry</button>
                </div>
                <div id="courses-menu" style="display:none;">
                    <button id="courses-json-import">Import Course</button>
                </div>
                <div id="results-menu" style="display:none;">
                    <button id="results-refresh">Refresh Results</button>
                    <button id="results-pdf">PDF Results</button>
                    <button id="results-html-single">Single Page HTML</button>
                </div>
                <div id='back' style="display:none;">
                    <button id='back-button'>Back</button>
                </div>
            </div>
        </div>
        <div id="scroll">

            <div id="main-screen" style="display:none;">
                <div class="card">
                    <img src="Nevis Logo.png" />
                    <h1>Nevis</h1>
                    <p> The Fast, Easy, Simple Software to process results from the SportIdent Timing System</p>
                </div>
                <div class="card" id="database">
                    <div id='text'>
                        <p id="current-database">Current Database:</p>
                        <p id="database-path">Select a Database</p>
                        <div class="text-input">

                            <input id="database-password" type="password" required/>
                            <label for="database-password">Password</label>
                        </div>
                    </div>



                </div>
            </div>

            <div id="download-output" style="display:none;" class="card">
            </div>
            <div id="entry-search" style="display:none;">
                <div class="card">
                    <div class="text-input">
                        <input id="name-search" required/>
                        <label for="name-search">Name</label>
                    </div>
                    <div class="text-input">
                        <input id="siid-search" required/>
                        <label for="siid-search">SI Number</label>
                    </div>

                    <div id="dropdown-input">
                        <p id="search-course-button">Course</p>
                        <ul id="search-course-dropdown" class="hidden">

                        </ul>
                    </div>
                </div>
                <div id="search-output" class="hidden">
                    <table id="search-output-table">

                    </table>
                </div>
            </div>

            <div id="entries" style="display:none;">
                <p class="card" id="entry-error" style="display:none;">Entry already exists for this SI Card</p>
                <div class="card">
                    <form>
                        <div class="text-input">
                            <input id="entries-name" required/>
                            <label for="entries-name">Name</label>
                        </div>
                        <div class="text-input">
                            <input id="entries-siid" required/>
                            <label for="entries-siid">SI Number</label>
                        </div>
                        <div class="text-input">
                            <input id="entries-mem-no" required/>
                            <label for="entries-mem-no">Membership Number</label>
                        </div>
                        <div class="text-input">
                            <input id="entries-age-class" required/>
                            <label for="entries-age-class">Age Class</label>
                        </div>
                        <div class="text-input">
                            <input id="entries-club" required/>
                            <label for="entries-club">Club</label>
                        </div>
                        <div id="dropdown-input">
                            <p id="entries-course">Course</p>
                            <ul id="entries-course-dropdown" class="hidden">

                            </ul>
                        </div>
                        <div class="checkbox-input">
                            <label for="entries-nc">Non-Competitive?
                                <input id="entries-nc" type="checkbox" required/>
                                <span for="entries-nc" />
                            </label>
                        </div>
                    </form>
                </div>
            </div>
            <div id="entry-download" class="card" style="display:none;">
                <h2 id="entry-download-time">Time :</h2>
                <h4 id="entry-download-controls">Controls:</h4>
            </div>
            <div id="courses-page" style="display:none;">
            </div>

            <div id="results" style="display:none;">
            </div>

            <div id="about" style="display:none;">
                <div class="card">
                    <h2>System</h2>
                    <p>Nevis Version: 2.0.0</p>
                    <p> Node Version:
                        <script>document.write(process.versions.node)</script> </p>
                    <p>Chrome Version:
                        <script>document.write(process.versions.chrome)</script> </p>
                    <p>Electron Version:
                        <script>document.write(process.versions.electron)</script>
                    </p>
                </div>
                <div class="card">
                    <h2>Credits</h2>
                    <h4>CRC Algorithm from opensportident</h4>
                    <p>MIT License - https://github.com/angexis/opensportident.js/ blob/master/LICENSE</p>
                    <p>
                        Copyright
                        <br/> (c) 2016 Jan Vorwerk
                        <br/>(c) 2013 Simon Denier
                    </p>

                    <h4> Serialport </h4>
                    <p> MIT License - https://github.com/node-serialport/node-serialport/ blob/master/LICENSE</p>
                    <p> Copyright (c) 2010 Christopher Williams. All rights reserved. </p>

                    <h4> Electron </h4>
                    <p> MIT License - https://github.com/electron/electron/ blob/master/LICENSE</p>
                    <p>Copyright (c) 2013-2017 GitHub Inc. </p>

                    <h4> Material Design Icons </h4>
                    <p> Apache 2.0 License - https://github.com/google/material-design-icons/ blob/master/LICENSE</p>


                    <h4> LokiJS </h4>
                    <p> MIT License - https://github.com/techfort/LokiJS/ blob/master/LICENSE.txt</p>
                    <p>Copyright (c) 2015 TechFort</p>


                    <h4> Crypto-JS</h4>
                    <p> MIT License - https://github.com/brix/crypto-js/ blob/develop/LICENSE</p>
                    <p>Copyright
                        <br/>(c) 2009-2013 Jeff Mott Copyright
                        <br/>(c) 2013-2016 Evan Vosberg</p>
                </div>
                <div class="card">
                    <h2>License</h2>
                    <h3> MIT License</h3>
                    <p>
                        Copyright (c) 2017 Bonalybob
                    </p>
                    <p>
                        Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation
                        files (the" Software"), to deal in the Software without restriction, including without limitation
                        the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the
                        Software, and to permit persons to whom the Software is furnished to do so, subject to the following
                        conditions: The above copyright notice and this permission notice shall be included in all copies
                        or substantial portions of the Software.
                    </p>
                    <p>
                        THE SOFTWARE IS PROVIDED"AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
                        OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
                        OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
                        CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
                        OTHER DEALINGS IN THE SOFTWARE.
                    </p>
                </div>

            </div>

        </div>
    </main>
    <script>
        const ipc = require('electron').ipcRenderer
        /* ----- Window Commands & Icons ----- */
        // Title Bar (Max and Min) + Scrollbar

        document.getElementById('icon-min').setAttribute('style', 'display:inline');
        document.getElementById('icon-max').setAttribute('style', 'display:none');

        document.getElementById('maximize').addEventListener('click', function () {
            ipc.send('window', 'maximize')
        })

        document.getElementById('minimize').addEventListener('click', function () {
            ipc.send('window', 'minimize')
        })

        ipc.on('window', function (event, arg) {
            if (arg == 'minimized') {
                document.getElementById('icon-min').setAttribute('style', 'display:inline')
                document.getElementById('icon-max').setAttribute('style', 'display:none')
            }
            else if (arg == 'maximized') {
                document.getElementById('icon-min').setAttribute('style', 'display:none')
                document.getElementById('icon-max').setAttribute('style', 'display:inline')
            }
        })

        ipc.on('resize', function (event, arg) {
            var pixels = arg[1] - 30
            var minusBackButtonPixels = pixels - 45
            document.getElementById('scroll').setAttribute('style', "height:" + pixels + "px")
            document.getElementById('scroll-menu').setAttribute('style', "height:" + minusBackButtonPixels + "px")
        })
    </script>
    <script>

        var fs = require('fs');
        const loki = require('lokijs');
        const BrowserWindow = require('electron').remote.BrowserWindow
        const path = require('path')
        const SerialPort = require('serialport');
        const printer = require('printer');
        const thermalPrinter = require('node-thermal-printer');
        var cryptedFileAdapter = require('./JS/encryption-adapter.js');

        document.getElementById('database-select').addEventListener('click', function () {
            ipc.send('select-database')
        })
        document.getElementById('database-new').addEventListener('click', function () {
            ipc.send('new-database')
        })
        ipc.on('database-file', function (event, path) {
            document.getElementById('database-path').innerText = path
        })
        document.getElementById('database-open').addEventListener('click', function () {
            if (document.getElementById('database-path').innerText != 'Select a Database') {
                cryptedFileAdapter.setKey(document.getElementById('database-password').value);
                db = new loki(document.getElementById('database-path').innerText, {
                    adapter: cryptedFileAdapter,
                    autoload: true,
                    autoloadCallback: databaseInitialize
                });
                document.getElementById('main-menu').setAttribute('style', 'display:block;')
                document.getElementById('database').setAttribute('class', 'card database-hidden')
                document.getElementById('database-menu').setAttribute('style', 'display:none;')
            }

        })
        ipc.on('database-file-create', function (event, arg) {
            document.getElementById('database-path').innerText = arg[0]
            cryptedFileAdapter.setKey(arg[3]);
            db = new loki(document.getElementById('database-path').innerText, {
                adapter: cryptedFileAdapter,
                autoload: true,
                autoloadCallback: databaseInitialize
            });
            document.getElementById('main-menu').setAttribute('style', 'display:block;')
            document.getElementById('database').setAttribute('class', 'card database-hidden')
            document.getElementById('database-menu').setAttribute('style', 'display:none;')
            eventData = db.addCollection("eventData");
            eventData.insert({
                name: arg[1],
                date: arg[2]
            })

        })
        /*cryptedFileAdapter.setKey('orienteer');
        db = new loki('./nevis.db', {
            adapter: cryptedFileAdapter,
            autoload: true,
            autoloadCallback: databaseInitialize
        });*/

        function databaseInitialize() {
            downloads = db.getCollection("downloads");
            if (downloads === null) {
                downloads = db.addCollection("downloads");
            }

            competitors = db.getCollection("competitors");
            if (competitors === null) {
                competitors = db.addCollection("competitors", {
                    unique: ['siid']
                });
            }

            courses = db.getCollection("courses");
            if (courses === null) {
                courses = db.addCollection("courses", {
                    unique: ['name']
                });
            }
            eventData = db.getCollection("eventData");

        }






        //Download Page
        require('./JS/downloads.js')

        //Entries Page
        require('./JS/entries.js')

        //Courses Page
        require('./JS/courses.js')

        //Results Page
        require('./JS/results.js')

        //Main Menu
        require('./JS/main-menu.js')

        /*document.getElementById('main-menu').setAttribute('style', 'display:block;')
        document.getElementById('database').setAttribute('class', 'card database-hidden')
        document.getElementById('database-menu').setAttribute('style', 'display:none;')*/



    </script>
</body>

</html>